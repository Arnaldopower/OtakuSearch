{% load static %}
{% include "base.html" with include_header=True %}
<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="{% static 'css/responsiveInfo.css' %}">
</head>
<body class="bg-[#f4effe]">
    <div class="alignSearch ml-[15px]">
            <div class="flex mt-2.5 alignSearch">
                <div class="flex alignVideo">
                    <div class="flex alignImage">
                        <div class="mr-[7px]">
                            <img class="imageAdjust" id="animeImage"></img>
                        </div>
                        <div class="descriptionAdjust">
                            <p class="bg-[#ecb7d0] max-w-[75px] text-[35px] rounded-[10px] font-kaushan" id="animeScore"></p>
                            <div class="italic text-[1.2em]">
                                <p id="animeRating"></p>
                                <p id="animeStatus"></p>
                                <p id="animeStudio"></p>
                                <p id="animeSource"></p>
                                <p id="animeGenre"></p>
                                <p id="animeEpisodes"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <iframe id="animeVideo" class="responsiveVideo ml-[50px]" width="420" height="315"></iframe>
            </div>

            <h1 id="animeTitle" class="font-kaushan text-[35px]"></h1>
            <p id="animeSynopsis" class="italic text-[1.2em]"></p>
        </div>
    </div>

    <script>
        let embedUrl, embedImg, title, score, synopsis, rating, status, studio, source, genres

        function getAnime(idAnime) {
            console.log(idAnime)
            fetch('https://api.jikan.moe/v4/anime/' + idAnime)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error connecting")
                    }
                    return response.json()
                })
                .then(data => {
                    console.log(data)
                    title = data["data"]['title']
                    embedImg = data["data"]["images"]["jpg"]["image_url"]
                    embedUrl = data["data"]["trailer"]["embed_url"]
                    score = data["data"]["score"] ? data["data"]["score"] : "N/A"
                    synopsis = data["data"]["synopsis"]
                    rating = data["data"]["rating"]
                    status = data["data"]["status"]
                    studio = data["data"]["studios"].length ? data["data"]["studios"][0]["name"] : "No studio working on it for now"
                    source = data["data"]["source"]
                    genres = data["data"]["genres"]
                    episodes = data["data"]["episodes"] ? data["data"]["episodes"] : "Not determinied"

                    renderText(title, document.getElementById('animeTitle'))
                    renderImage(embedImg, document.getElementById('animeImage'))
                    renderVideo(embedUrl, document.getElementById('animeVideo'))
                    renderText(score, document.getElementById('animeScore'))
                    renderText(synopsis, document.getElementById('animeSynopsis'))
                    renderText("Rating: " + rating, document.getElementById('animeRating'))
                    renderText("Status: " + status, document.getElementById('animeStatus'))
                    renderText("Studio: " + studio, document.getElementById('animeStudio'))
                    renderText("Source: " + source, document.getElementById('animeSource'))
                    renderText("Episodes: " + episodes, document.getElementById('animeEpisodes'))
                    genres.forEach(element => {
                        renderText(element["name"] + "-", document.getElementById('animeGenre'))
                    });
                })
                .catch(error => (console.log("Error obtaining elements", error)))
        }

        function getManga(idManga) {
            fetch('https://api.jikan.moe/v4/manga/' + idManga)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error connecting")
                    }
                    return response.json()
                })
                .then(data => {
                    console.log(data)

                    title = data["data"]['title']
                    embedImg = data["data"]["images"]["jpg"]["image_url"]
                    embedUrl = null
                    score = data["data"]["score"] ? data["data"]["score"] : "N/A"
                    synopsis = data["data"]["synopsis"]
                    rating = data["data"]["authors"]
                    status = data["data"]["status"]
                    studio = data["data"]["serializations"].length ? data["data"]["serializations"][0]["name"] : "No serialization for now"
                    source = data["data"]["chapters"]
                    genres = data["data"]["genres"]


                    renderText(title, document.getElementById('animeTitle'))
                    renderImage(embedImg, document.getElementById('animeImage'))
                    renderVideo(embedUrl, document.getElementById('animeVideo'))
                    renderText(score, document.getElementById('animeScore'))
                    renderText(synopsis, document.getElementById('animeSynopsis'))
                    rating.forEach(element => {
                        renderText(element["name"] + "-", document.getElementById('animeRating'))
                    });
                    renderText("Status: " + status, document.getElementById('animeStatus'))
                    renderText("Serialization: " + studio, document.getElementById('animeStudio'))
                    renderText("Chapters: " + source, document.getElementById('animeSource'))
                    genres.forEach(element => {
                        renderText(element["name"] + "-", document.getElementById('animeGenre'))
                    });
                })
                .catch(error => (console.log("Error obtaining elements", error)))
        }

        function renderVideo(embedUrl, iframe) {
            if (embedUrl) {
                iframe.src = embedUrl + '?autoplay=0';
            } else {
                iframe.style.display = "none"
            }
        }

        function renderImage(embedImg, img) {
            img.src = embedImg
        }

        function renderText(title, p) {
            p.innerText += title
        }
        console.warn('{{entry_type  }}')
        {% if entry_type == 'anime' %}
            console.log('{{context.entry.id}}')
            getAnime('{{entry.id}}')
        {% else %}
            console.log('{{entry.id}}')
            getManga('{{ entry.id }}')
        {% endif %}
        function editFunction(){
            let formEdit = document.getElementById({{ comment_id }})
            if (formEdit.style.display === "none") {
                formEdit.style.display = "block";
                } else {
                    formEdit.style.display = "none";
            }

        }
        getAnime('{{anime.id_anime}}')
    </script>
</body>

<form id="create" action="" method="post">
    {% csrf_token %}
    <table>
        {{form.as_table}}
    </table>
    <input id="submit_comment" type="submit" value="Submit">
</form>
{% for comment in comments %}
    <h4>
        {{ comment }}
    </h4>
    {% if comment.author == user %}
        <form id="delete" action="" method="post">
            <input type="hidden" name="deleteComment" value="{{ comment.id }}">
            <button id="delete_comment" type="submit">Delete</button>
            {% csrf_token %}
        </form>
        <button onclick="editFunction()">edit</button>
            <div id="{{comment_id}}">
                <form id="edit_form" action="" method="post">
                    <input type="hidden" name="modifyComment" value="{{ comment.id }}">
                    <table>
                        {{form_edit_comment.as_table}}
                    </table>
                    <input id="edit_submit" type="submit" value="Submit edit">
                    {% csrf_token %}
                </form>
            </div>
    {% endif %}
{% endfor %}
